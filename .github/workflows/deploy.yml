name: Deploy to IONOS VPS

on:
  push:
    branches:
      - main # Se ejecuta automÃ¡ticamente al hacer push a main
  workflow_dispatch: # TambiÃ©n permite ejecutarlo manualmente desde GitHub

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ“¦ Iniciando despliegue en IONOS VPS..."

            # Ir al directorio del proyecto
            cd ~/epicstoria || exit 1

            # Actualizar cÃ³digo desde GitHub
            echo "ğŸ”„ Descargando Ãºltimos cambios..."
            git pull origin main

            # Backend
            echo "ğŸ”§ Actualizando backend..."
            cd backend
            npm install --production
            npm run build

            # Ejecutar migraciones si existen nuevas
            npm run db:migrate || echo "âš ï¸ No hay migraciones nuevas"

            # Frontend
            echo "ğŸ¨ Actualizando frontend..."
            cd ..
            npm install --production
            npm run build:ssr

            # Reiniciar servicios con PM2
            echo "ğŸ”„ Reiniciando servicios..."
            pm2 restart epicstoria-backend || pm2 start backend/dist/index.js --name epicstoria-backend
            pm2 restart epicstoria-frontend || pm2 start dist/epicstoria/server/server.mjs --name epicstoria-frontend

            # Guardar configuraciÃ³n de PM2
            pm2 save

            # Mostrar estado final
            echo "âœ… Despliegue completado!"
            pm2 status

      - name: âœ… Deployment Status
        if: success()
        run: echo "ğŸ‰ Despliegue exitoso en IONOS VPS!"

      - name: âŒ Deployment Failed
        if: failure()
        run: echo "ğŸ’¥ Error en el despliegue. Revisa los logs."
