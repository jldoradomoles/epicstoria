import{a as ee}from"./chunk-EZHIFFGH.js";import{a as z,c as G,d as J,e as K,f as X,g as Y,n as Z}from"./chunk-SFHHH3KZ.js";import{a as q,b as C}from"./chunk-HWYJJFZ5.js";import{h as B,i as P,p as Q,r as W}from"./chunk-XDCWJPAS.js";import{$a as h,Ab as d,Bb as U,Cb as k,Db as A,Eb as V,Fb as F,Gb as $,Ha as p,M as D,Ma as T,R as S,W as b,X as x,ab as f,db as j,eb as N,fb as w,gb as n,ha as c,hb as a,ib as u,mb as R,o as g,rb as y,tb as v,ub as H,v as E,vb as L,wb as O,za as o,zb as I}from"./chunk-C264W5OG.js";var M=class r{apiUrl=q.apiUrl;authService=S(C);http=S(P);getAuthHeaders(){let t=this.authService.getToken();return new B({Authorization:`Bearer ${t}`})}getMessages(t){return this.http.get(`${this.apiUrl}/chat/${t}`,{headers:this.getAuthHeaders()}).pipe(g(e=>e.data))}sendMessage(t,e){return this.http.post(`${this.apiUrl}/chat/send`,{receiver_id:t,message:e},{headers:this.getAuthHeaders()}).pipe(g(i=>i.data))}markAsRead(t){return this.http.put(`${this.apiUrl}/chat/read/${t}`,{},{headers:this.getAuthHeaders()}).pipe(g(()=>{}))}getUnreadCount(){return this.http.get(`${this.apiUrl}/chat/unread`,{headers:this.getAuthHeaders()}).pipe(g(t=>t.data.count))}static \u0275fac=function(e){return new(e||r)};static \u0275prov=D({token:r,factory:r.\u0275fac,providedIn:"root"})};var se=["messagesContainer"],ne=(r,t)=>t.id;function ae(r,t){if(r&1&&(n(0,"div",6)(1,"div",17),d(2),a(),n(3,"div")(4,"h1",18),d(5),a(),n(6,"p",19),d(7),a()()()),r&2){let e,i=v();o(2),A(" ",i.otherUser().name.charAt(0).toUpperCase(),"",((e=i.otherUser().lastname)==null||(e=e.charAt(0))==null?null:e.toUpperCase())||""," "),o(3),A(" ",i.otherUser().name," ",i.otherUser().lastname," "),o(2),U(i.otherUser().email)}}function oe(r,t){r&1&&(n(0,"div",9),u(1,"i",20),n(2,"span",21),d(3,"Cargando mensajes..."),a()())}function le(r,t){r&1&&(n(0,"div",9)(1,"div",22),u(2,"i",23),n(3,"p",24),d(4,"No hay mensajes a\xFAn"),a(),n(5,"p",25),d(6,"Inicia la conversaci\xF3n"),a()()())}function de(r,t){if(r&1&&(n(0,"div")(1,"div")(2,"p",27),d(3),a()()()),r&2){let e,i,s=t.$implicit,l=v(2);I(s.sender_id===((e=l.currentUser())==null?null:e.id)?"flex justify-end":"flex justify-start"),o(),I(s.sender_id===((i=l.currentUser())==null?null:i.id)?"max-w-[70%] bg-gradient-to-r from-amber-600 to-amber-700 text-white rounded-2xl rounded-tr-sm p-4 shadow-lg":"max-w-[70%] bg-stone-800/50 text-color rounded-2xl rounded-tl-sm p-4 shadow-lg border border-amber-900/20"),o(2),U(s.message)}}function me(r,t){if(r&1&&j(0,de,4,5,"div",26,ne),r&2){let e=v();N(e.messages())}}function ce(r,t){if(r&1&&(n(0,"div",11),d(1),a()),r&2){let e=v();o(),k(" ",e.errorMessage()," ")}}function pe(r,t){r&1&&u(0,"i",15)}function ue(r,t){r&1&&u(0,"i",16)}var te=class r{constructor(t,e,i,s,l){this.route=t;this.router=e;this.authService=i;this.chatService=s;this.friendshipService=l}messagesContainer;otherUserId=c(null);otherUser=c(null);messages=c([]);newMessage="";isLoadingMessages=c(!1);isSending=c(!1);errorMessage=c("");isInitialLoad=c(!0);pollingSubscription;get currentUser(){return this.authService.currentUser}ngOnInit(){this.route.params.subscribe(t=>{let e=parseInt(t.userId);if(isNaN(e)){this.router.navigate(["/perfil"]);return}this.otherUserId.set(e),this.loadOtherUser(e),this.loadMessages(),this.startPolling()})}ngOnDestroy(){this.stopPolling()}loadOtherUser(t){this.friendshipService.getAllUsers().subscribe({next:e=>{let i=e.find(s=>s.id===t);i?this.otherUser.set(i):(this.errorMessage.set("Usuario no encontrado"),setTimeout(()=>this.router.navigate(["/perfil"]),2e3))},error:e=>{console.error("Error al cargar usuario:",e),this.errorMessage.set("Error al cargar informaci\xF3n del usuario")}})}loadMessages(t=!0){let e=this.otherUserId();e&&(t&&this.isLoadingMessages.set(!0),this.chatService.getMessages(e).subscribe({next:i=>{let s=this.messages().length===0||this.isInitialLoad();this.messages.set(i),this.isLoadingMessages.set(!1),this.isInitialLoad.set(!1),s&&setTimeout(()=>this.scrollToBottom(),100)},error:i=>{console.error("Error al cargar mensajes:",i),t&&this.errorMessage.set("Error al cargar mensajes"),this.isLoadingMessages.set(!1),this.isInitialLoad.set(!1)}}))}sendMessage(t){t.preventDefault();let e=this.newMessage.trim(),i=this.otherUserId();!e||!i||(this.isSending.set(!0),this.errorMessage.set(""),this.chatService.sendMessage(i,e).subscribe({next:()=>{this.newMessage="",this.isSending.set(!1),this.loadMessages(!1)},error:s=>{console.error("Error al enviar mensaje:",s),this.errorMessage.set("Error al enviar mensaje"),this.isSending.set(!1)}}))}startPolling(){this.pollingSubscription=E(3e3).subscribe(()=>{this.loadMessages(!1)})}stopPolling(){this.pollingSubscription&&this.pollingSubscription.unsubscribe()}scrollToBottom(){try{if(this.messagesContainer){let t=this.messagesContainer.nativeElement;t.scrollTop=t.scrollHeight}}catch(t){console.error("Error al hacer scroll:",t)}}formatMessageTime(t){let e=new Date(t),s=new Date().getTime()-e.getTime(),l=Math.floor(s/(1e3*60)),m=Math.floor(s/(1e3*60*60)),_=Math.floor(s/(1e3*60*60*24));return l<1?"Ahora":l<60?`Hace ${l} min`:m<24?`Hace ${m}h`:_===1?"Ayer":_<7?`Hace ${_} d\xEDas`:e.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"})}goBack(){this.router.navigate(["/perfil"])}static \u0275fac=function(e){return new(e||r)(p(Q),p(W),p(C),p(M),p(ee))};static \u0275cmp=T({type:r,selectors:[["app-chat"]],viewQuery:function(e,i){if(e&1&&H(se,5),e&2){let s;L(s=O())&&(i.messagesContainer=s.first)}},decls:20,vars:7,consts:[["messagesContainer",""],[1,"min-h-screen","py-8","px-4"],[1,"max-w-4xl","mx-auto"],[1,"mb-6"],[1,"text-color","hover:text-amber-200","mb-4","flex","items-center","gap-2","transition-colors",3,"click"],[1,"fas","fa-arrow-left"],[1,"flex","items-center","gap-4"],[1,"container-custom","rounded-xl","overflow-hidden","flex","flex-col",2,"height","600px"],[1,"flex-1","overflow-y-auto","p-6","space-y-4"],[1,"flex","items-center","justify-center","h-full"],[1,"border-t","border-amber-900/30","p-4","bg-stone-900/30"],[1,"mb-3","p-3","bg-red-900/50","border","border-red-500/50","rounded-lg","text-red-200","text-sm"],[1,"flex","gap-3",3,"submit"],["type","text","name","message","placeholder","Escribe un mensaje...",1,"flex-1","px-4","py-3","bg-stone-800/50","border","border-amber-900/30","rounded-lg","text-color","placeholder-amber-100/40","focus:outline-none","focus:border-amber-500/50","focus:ring-1","focus:ring-amber-500/30","transition-colors","disabled:opacity-50",3,"ngModelChange","ngModel","disabled"],["type","submit",1,"px-6","py-3","bg-gradient-to-r","from-amber-600","to-amber-700","hover:from-amber-500","hover:to-amber-600","text-white","font-semibold","rounded-lg","transition-all","duration-300","disabled:opacity-50","disabled:cursor-not-allowed","flex","items-center","gap-2",3,"disabled"],[1,"fas","fa-spinner","fa-spin"],[1,"fas","fa-paper-plane"],[1,"w-12","h-12","rounded-full","bg-gradient-to-br","from-amber-600","to-amber-800","flex","items-center","justify-center","text-xl","font-bold","text-white","shadow-lg"],[1,"text-2xl","font-bold","text-color"],[1,"text-color"],[1,"fas","fa-spinner","fa-spin","text-3xl","text-amber-400"],[1,"ml-3","text-amber-200","text-lg"],[1,"text-center"],[1,"fas","fa-comments","text-5xl","text-amber-900/50","mb-4"],[1,"text-color","text-xl"],[1,"text-color","text-lg","mt-2"],[3,"class"],[1,"break-words","whitespace-pre-wrap"]],template:function(e,i){if(e&1){let s=R();n(0,"div",1)(1,"div",2)(2,"div",3)(3,"button",4),y("click",function(){return b(s),x(i.goBack())}),u(4,"i",5),d(5," Volver "),a(),h(6,ae,8,5,"div",6),a(),n(7,"div",7)(8,"div",8,0),h(10,oe,4,0,"div",9)(11,le,7,0,"div",9)(12,me,2,0),a(),n(13,"div",10),h(14,ce,2,1,"div",11),n(15,"form",12),y("submit",function(m){return b(s),x(i.sendMessage(m))}),n(16,"input",13),$("ngModelChange",function(m){return b(s),F(i.newMessage,m)||(i.newMessage=m),x(m)}),a(),n(17,"button",14),h(18,pe,1,0,"i",15)(19,ue,1,0,"i",16),a()()()()()()}e&2&&(o(6),f(i.otherUser()?6:-1),o(4),f(i.isLoadingMessages()?10:i.messages().length===0?11:12),o(4),f(i.errorMessage()?14:-1),o(2),V("ngModel",i.newMessage),w("disabled",i.isSending()),o(),w("disabled",!i.newMessage.trim()||i.isSending()),o(),f(i.isSending()?18:19))},dependencies:[Z,Y,z,G,J,X,K],encapsulation:2})};export{te as ChatComponent};
